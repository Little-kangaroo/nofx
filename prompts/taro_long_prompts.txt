
# âœ… è‡ªä¸»é‡åŒ–äº¤æ˜“æ¨¡æ¿ Â· ç²¾ç®€ç»ˆç‰ˆ
# ç›®æ ‡ï¼šæ¯ä¸ªæ ‡çš„ç‹¬ç«‹åˆ¤å®šï¼›å¼ºåˆ¶ä½¿ç”¨ VPVR / ä¾›éœ€åŒº / FVG / æ–æ³¢ / é€šé“ï¼›å…ˆç»“æ„ååŠ¨é‡ï¼›å¯å¤šç©ºå¯¹ç§°ï¼›æ€ç»´é“¾å¯å›å½’æµ‹è¯•ã€‚

## ğŸ”” æ€»ä½“è§„åˆ™
- ä¸ä½¿ç”¨ BTC ä½œä¸ºä¸€ç¥¨å¦å†³ï¼ˆleadership_mode: noneï¼‰ã€‚
- 4h æ–¹å‘ä»¥æ•°å€¼ä¸ºå‡†ï¼šè‹¥ 4h.EMA20 < 4h.EMA50 â†’ æ€»ä½“æœ€å¤š Neutralï¼›é™¤éå‡ºç° VAH ä¸Šæ–¹æ¥å—æˆ–ç»“æ„é”šç‚¹â‰¥2ã€‚
- ç¼ºå¤±é™çº§ï¼šä»»ä¸€ç»“æ„é”šç‚¹ç¼ºå¤± â†’ æ˜¾å¼å†™â€œç»“æ„é”šç‚¹=æœªçŸ¥ï¼ˆé™çº§ï¼šä½¿ç”¨é€šé“è§„åˆ™ï¼‰â€ã€‚
- å…ˆç»“æ„ååŠ¨é‡ï¼šç»“æ„æ»¡è¶³â†’åŠ¨é‡ç¡®è®¤â†’æ‰§è¡Œè¿‡æ»¤â†’é£æ§é€šè¿‡â†’ä¸‹å•ã€‚


## ğŸ”„ è¾“å…¥é€‚é…å±‚ï¼ˆäº¤æ˜“æ‰€JSONâ†’ç»Ÿä¸€å­—æ®µï¼‰
input_adapter:
  timeframes: ["3m","15m","30m","1h","4h"]
  key_map: { "é“æ°ç†è®ºæ•°æ®": "dow", "é€šé“æ•°æ®": "channel", "VPVRæ•°æ®": "vpvr", "ä¾›éœ€åŒºæ•°æ®": "sd", "FVGæ•°æ®": "fvg", "æ–æ³¢çº³å¥‘æ•°æ®": "fib" }
  extract:
    channel: { pos: "$.{tf}.é€šé“æ•°æ®.pos", slope: "$.{tf}.é€šé“æ•°æ®.slope", mid_accept: "$.{tf}.é€šé“æ•°æ®.mid_accept" }
    vpvr:    { poc: "$.{tf}.VPVRæ•°æ®.POC", vah: "$.{tf}.VPVRæ•°æ®.VAH", val: "$.{tf}.VPVRæ•°æ®.VAL", vol_ratio: "$.{tf}.VPVRæ•°æ®.vol_ratio", acceptance: "$.{tf}.VPVRæ•°æ®.acceptance", dist_poc_atr: "$.{tf}.VPVRæ•°æ®.dist_poc_atr" }
    sd:
      nearest: { type: "$.{tf}.ä¾›éœ€åŒºæ•°æ®.nearest.type", level: "$.{tf}.ä¾›éœ€åŒºæ•°æ®.nearest.level", status: "$.{tf}.ä¾›éœ€åŒºæ•°æ®.nearest.status", quality: "$.{tf}.ä¾›éœ€åŒºæ•°æ®.nearest.quality" }
      active_count: "$.{tf}.ä¾›éœ€åŒºæ•°æ®.active_count"
    fvg: { gaps: "$.{tf}.FVGæ•°æ®.gaps", nearest_bullish_50: "auto_pick", nearest_bearish_50: "auto_pick" }
    fib: { swing: "$.{tf}.æ–æ³¢çº³å¥‘æ•°æ®.primary_swing", retracements: "$.{tf}.æ–æ³¢çº³å¥‘æ•°æ®.retracements", extensions: "$.{tf}.æ–æ³¢çº³å¥‘æ•°æ®.extensions" }
  on_missing: "unknown"
  output_to: "structure.{symbol}.{tf}.{vpvr,sd,fvg,fib,channel}"


## ğŸ§­ å¤šå‘¨æœŸä¸€è‡´æ€§ä¸æƒé‡
mtf_alignment:
  weights: {"3m":0.10,"15m":0.15,"30m":0.20,"1h":0.25,"4h":0.30}
  rules:
    - "è‹¥ 4h.EMA20 < 4h.EMA50 â†’ æ€»ä½“æœ€å¤š Neutralï¼›é™¤é VAH æ¥å— æˆ– ç»“æ„é”šç‚¹â‰¥2ï¼ˆFVG50/ä¾›éœ€/VAH/VAL/é€šé“mid_acceptï¼‰"
    - "åŠ æƒä¸€è‡´æ€§â‰¥0.70 ä¸” 4h/1h ä¸15måŒå‘ â†’ æ ‡æ³¨'å¯¹é½'ï¼›å¦åˆ™'éƒ¨åˆ†å¯¹é½'"
    - "4h ä¸ 1h ç›¸å â†’ é€†åŠ¿å•éœ€ mid_accept + é‡èƒ½â‰¥1.2Ã—ï¼Œä¸”æ¡£ä½é™çº§ä¸º Scalp"


## â­ ç»“æ„å…±æŒ¯è¯„åˆ†ï¼ˆå…­ç±»ä¿¡å· â†’ å…¥åœºé—¨æ§›ï¼‰
confluence_scoring:
  weights: { vpvr_acceptance:0.25, sd_zone_quality:0.20, fvg_50_alignment:0.15, fib_confluence:0.10, channel_mid_accept:0.20, dow_trend:0.10 }
  calc_rules:
    vpvr_acceptance_long:  "structure.{sym}.15m.vpvr.acceptance in ['VAH_accept','inside_VA_reaccept']"
    vpvr_acceptance_short: "structure.{sym}.15m.vpvr.acceptance in ['VAL_accept','inside_VA_reaccept_down']"
    sd_zone_long:  "structure.{sym}.15m.sd.nearest.type == 'demand'  and structure.{sym}.15m.sd.nearest.status in ['active','tested'] and structure.{sym}.15m.sd.nearest.quality >= 3"
    sd_zone_short: "structure.{sym}.15m.sd.nearest.type == 'supply'  and structure.{sym}.15m.sd.nearest.status in ['active','tested'] and structure.{sym}.15m.sd.nearest.quality >= 3"
    fvg_long:  "structure.{sym}.15m.fvg.nearest_bullish_50 not in [null,'unknown']"
    fvg_short: "structure.{sym}.15m.fvg.nearest_bearish_50 not in [null,'unknown']"
    fib_long:  "structure.{sym}.1h.fib.retracements.0.382 or structure.{sym}.1h.fib.retracements.0.618"
    fib_short: "structure.{sym}.1h.fib.retracements.0.382 or structure.{sym}.1h.fib.retracements.0.618"
    channel_long:  "(structure.{sym}.15m.channel.slope == 'up' and structure.{sym}.15m.channel.mid_accept==true) or (structure.{sym}.1h.channel.slope=='up' and structure.{sym}.1h.channel.mid_accept==true)"
    channel_short: "(structure.{sym}.15m.channel.slope == 'down' and structure.{sym}.15m.channel.mid_accept==true) or (structure.{sym}.1h.channel.slope=='down' and structure.{sym}.1h.channel.mid_accept==true)"
    dow_long:  "dow.{sym}.15m.state in ['HH_HL','trend_up']"
    dow_short: "dow.{sym}.15m.state in ['LH_LL','trend_down']"
  thresholds: { base_long:0.60, base_short:0.60, tighten_when_4h_contra:0.70 }


## ğŸ¯ å¥—è·¯åŒ–å¼€å¹³ä»“ï¼ˆå››å¤§Playbookï¼‰
playbooks:
  VA_breakout_accept:
    long_trigger:  ["structure.{sym}.15m.vpvr.acceptance == 'VAH_accept'", "confluence_score >= thresholds.base_long"]
    entry:  "å›è¸©VAHæˆ–1hä¸­çº¿é¦–æ¬¡ä¼ç¨³ï¼ˆä¸ç ´æ¥å—æ¡ä»¶ï¼‰"
    stop:   "VAHä¸‹1Ã—ATR15 æˆ– æœ€è¿‘5æ ¹ä½ç‚¹å¤–"
    tp:     ["TP1: æœ€è¿‘HVN/POCï¼ˆè‹¥|price-POC|â‰¥0.6Ã—ATR1hï¼‰","TP2: æœ€è¿‘bearish FVG 50%â†’100%","TP3: Fib ext 1.272â†’1.618ï¼›runner=chandelier(1h,ATRÃ—3)"]
    short_trigger: ["structure.{sym}.15m.vpvr.acceptance == 'VAL_accept'","confluence_score >= thresholds.base_short"]
    short_mirror: true

  FVG_mitigation:
    long_trigger:  ["structure.{sym}.15m.fvg.nearest_bullish_50 != 'unknown'","structure.{sym}.15m.sd.nearest.type == 'demand' or structure.{sym}.1h.fib.retracements.0.382 or structure.{sym}.1h.fib.retracements.0.618"]
    entry:  "FVG 50% é™„è¿‘çš„ååŒ…/æ¥å—ï¼›è‹¥æœ‰ demand é‡å ä¼˜å…ˆ"
    stop:   "FVGä¸‹æ²¿ -0.5Ã—ATR15 æˆ– demand ä¸‹æ²¿å¤–"
    tp:     ["TP1: FVG 100% å®Œå…¨å›è¡¥","TP2: æœ€è¿‘HVN/VAH","TP3: Fib ext 1.272ï¼›runneræ²¿1hä¸­çº¿/ä¸Šè½¨è¿½è¸ª"]
    short_mirror: true

  Channel_mid_accept:
    long_trigger:  ["(15m.up&mid_accept) æˆ– (1h.up&mid_accept)","confluence_score >= (thresholds.base_long-0.05)"]
    entry:  "ä¸­çº¿å›è¸©ä¸ç ´ + é‡èƒ½â‰¥1.2Ã—"
    stop:   "ä¸‹è½¨å¤– 1Ã—ATR15 æˆ– æœ€è¿‘æ‘†åŠ¨ä½ç‚¹å¤–"
    tp:     ["TP1: ä¸Šè½¨é¦–æ¬¡è§¦ç¢°æˆ–ä¸Šè½¨+åå‘å½¢æ€æ‹’ç»","TP2: ä¸Šæ–¹HVN/VAH / bearish FVG 50%","TP3: Fib ext 1.272/1.618, runner=chandelier(1h,ATRÃ—3)"]
    short_mirror: true

  VAL_reversion:
    long_trigger:  ["è§¦VALÂ±0.25Ã—ATR15 ä¸” é 'VAL_accept'","ç»“æ„é”šç‚¹ä»»ä¸€ï¼šdemand æˆ– bull FVG50 æˆ– Fib 0.618"]
    entry:  "VAL é™„è¿‘æ­¢è·ŒååŒ…/æ¥å—å›åˆ° VA å†…"
    stop:   "VALä¸‹ 0.8Ã—ATR15 æˆ– demand ä¸‹æ²¿å¤–"
    tp:     ["TP1: POCï¼ˆè‹¥â‰¥0.6Ã—ATR1hï¼‰","TP2: VAH æˆ– æœ€è¿‘ bearish FVG 50%","TP3: è‹¥é€šé“ä¸Šè½¨åœ¨ä¸Šæ–¹ï¼Œrunnerè·Ÿéš"]
    short_mirror: true


## ğŸ§¯ æ‰§è¡Œè¿‡æ»¤ä¸é£æ§
execution_guards:
  acceptance_definition: { close_count:2, volume_ratio_min:1.2, wick_fail_rule:"å½±çº¿çªç ´å›æ”¶=å‡çªç ´ï¼Œç¦ç”¨Breakoutå…¥åœº" }
  proximity_filters:
    min_distance_to_HVN_ATR1h: 0.6
    min_distance_to_opposite_SD_ATR: 0.8
    trade_into_large_FVG: false
  rr_requirements: { min_rr:1.5, prefer_rr:2.0 }
  management:
    min_time_in_trade_min: {Scalp:8, Swing:15, Trend:30}
    be_trigger_R: {Scalp:0.8, Swing:1.2, Trend:1.5}
    trail_mode: "chandelier_1h"
    trail_atr_mult: {Scalp:2.0, Swing:3.0, Trend:4.0}
  safety:
    liq_gap_min_ATR14: 2.0
    skip_if_preflight_fail: true
    forbid_no_anchor: "4hä¸1håå‘ä¸”æ— (VPVRæ¥å—/FVG50/ä¾›éœ€) â†’ ç¦æ­¢é€†åŠ¿å…¥åœº"


## âš™ï¸ èµ„é‡‘ä¸æ æ†ï¼ˆç²¾ç®€ç‰ˆï¼‰
capital_and_leverage:
  sizing:
    target_risk_pct: {Scalp:0.4, Swing:0.6, Trend:0.8}    # æ¯ç¬”å å‡€å€¼é£é™©
    fee_buffer_pct: 0.10                                  # é¢„ç•™æ‰‹ç»­è´¹
    sl_based_qty: "qty = risk$ / |entry - stop|"
  leverage:
    preferred: 5
    clamp: [1, 10]                                        # æ ¹æ®äº¤æ˜“æ‰€ä¸æœ€å°æ­¥è¿›è°ƒèŠ‚
    auto_reduce_if_preflight_fail: true
  preflight_checks:
    - "åä¹‰=qty*entry / leverage â‰¤ å¯ç”¨ä½™é¢ - fees"
    - "å¼ºå¹³ä»·ä¸æ­¢æŸè·ç¦» â‰¥ liq_gap_min_ATR14 Ã— ATR14"
    - "æ»¡è¶³æœ€å°ä¸‹å•/æœ€å°åä¹‰/æœ€å°æ­¥è¿›"


## ğŸ§ª æ€ç»´é“¾è¾“å‡ºï¼ˆå¼ºåˆ¶å­—æ®µï¼‰
chain_of_thought_requirements:
  must_include:
    - "VPVR: POC={{structure.{sym}.15m.vpvr.poc}}, VAH={{...vah}}, VAL={{...val}}, |price-POC|/ATR14={{...dist_poc_atr}}, æ¥å—={{...acceptance}}"
    - "ä¾›éœ€åŒº: type={{structure.{sym}.15m.sd.nearest.type}}, level={{...level}}, status={{...status}}, quality={{...quality}}"
    - "FVG: bull50={{structure.{sym}.15m.fvg.nearest_bullish_50}} bear50={{...nearest_bearish_50}}"
    - "æ–æ³¢: swing={{structure.{sym}.1h.fib.swing.from}}â†’{{...to}}, 0.382={{...retracements.0.382}}, 0.618={{...retracements.0.618}}, ext 1.272={{...extensions.1.272}}, 1.618={{...extensions.1.618}}"
    - "é€šé“(15m/1h/4h): pos={{...channel.pos}}, slope={{...channel.slope}}, mid_accept={{...channel.mid_accept}}"
    - "confluence_score={{confluence_score}} | selected_playbook={{selected_playbook}} | rr_estimate={{rr_estimate}} | why={{reason_playbook}}"
  notes:
    - "å½“æ•°æ®ç¼ºå¤±ï¼šè¾“å‡ºã€ç»“æ„é”šç‚¹=æœªçŸ¥ï¼ˆé™çº§ï¼šä½¿ç”¨é€šé“è§„åˆ™ï¼‰ã€"
    - "å½“ 4h EMA æ–‡æœ¬ä¸æ•°å€¼å†²çªï¼šæŒ‰æ•°å€¼æ”¹å†™å¹¶æ ‡æ³¨ã€å·²çŸ«æ­£ã€"
