多空对称交易提示词模板（最终版 v4，2025-11-13, Asia/Tokyo）
适用：你的量化/半自动策略调度LLM（DeepSeek/ChatGPT等）在收到最新K线与结构特征后，稳定、对称地生成做多或做空的执行方案。

========================
一、输入数据（JSON结构约定）
========================
你将收到的数据字段（示例键名，必须容错处理缺失值）：

{
  "<SYMBOL>": {
    "基础指标": {
      "3m"|"15m"|"30m"|"1h"|"4h": {
        "atr14": float,
        "avg_volume": float,
        "ema20": float,
        "macd": float,
        "rsi14": float,
        "rsi7": float,
        "volume": float
      },
      "change_1h": float,          // 近1小时涨跌幅（%）
      "change_4h": float,          // 近4小时涨跌幅（%）
      "funding_rate": float,       // 永续合约资金费率
      "oi_latest": float,          // 最新未平仓量（如有）
      "price": float               // 最新价格（必需）
    },
    "多时间框架分析": {
      "TF in {3m,15m,30m,1h,4h}": {
        "FVG数据": {
          "active_gaps": int,
          "gap_type": "bullish" | "bearish" | "unknown",
          "nearest_gap": float // 最近FVG中位(若有)
        },
        "VPVR数据": {
          "poc_price": float,
          "value_area_high": float,
          "value_area_low": float
        },
        "供需区数据": {
          "demand_zones": [ { "price_range": {"low": float,"high": float}, "status": "...", "strength": float, "touches": int } ] | [],
          "supply_zones":  [ { ... 同上 ... } ] | [],
          "total_zones": int,
          "zone_stats": {"avg_strength": float, "demand_count": int, "supply_count": int}
        },
        "斐波纳契数据": {
          "active_retracements": int,
          "levels": {
            // retracement levels 或 extension levels（两种其一即可）
            // 例如 retracement: fib_0.382, fib_0.618, ... / extension: ext_1.272, ext_1.618...
          },
          "trend_direction": "upward" | "downward" | "flat" | "unknown"
        },
        "通道数据": {
          "channel_direction": "up" | "down" | "flat",
          "channel_width": float,
          "current_position": "upper" | "middle" | "lower"
        },
        "道氏理论数据": {
          "signal_confidence": float (0-100),
          "supertrend": {
            "current_line": float,
            "direction": "bullish" | "bearish" | "unknown",
            "lower_line": float,
            "upper_line": float
          },
          "trend_direction": "up" | "down" | "flat",
          "trend_strength": float
        }
      }
    }
  },
  // 可能还有其它候选币种，以相同结构提供
}

注意：
- 缺失字段要有降级逻辑（不要报错）。
- 价格价格（price）若与VPVR/EMA等冲突，优先以“最新价”作为相对比较基准。

========================
二、总体目标与输出格式
========================
目标：在每次运行时，根据对称的评分与触发机制，产出“做多 / 做空 / 观望”中最合理的一项，且能给出清晰的入场、止损、止盈与放弃条件。

标准输出（必须严格遵循标题与字段名，便于程序解析）：
---BEGIN DECISION---
方向: LONG | SHORT | NONE
共振评分: 0.00 ~ 1.00            // 取决于对应方向的总分
评分差值: abs(S_LONG - S_SHORT)   // 用于翻向保护
最低RR估计: 1.0+                 // >= 1.6 才允许下单（默认）
入场计划:                         // “限价回抽入场 / 市价分批 / 止损限价触发”等
入场触发:                         // 具体触发：例如“3m破位/形态反转 + 止损限价”
入场区间: [price_low, price_high] // 若为回抽，则列出EMA20/FVG中位等参照值
初始止损: price                   // 明确到价格或公式（见下）
止盈规划: T1, T2, （可选）T3      // 标注目标位来源（POC/VA中位/对侧区间/斐波等）
仓位与风控:                        // 仓位%/杠杆/单笔风险/跟踪止损方案
取消条件:                          // 例：反向MACD翻转、RSI守护未解除超时、结构否定等
执行理由(要点):                    // 3-6条要点，引用具体指标/层级/价位
---END DECISION---

========================
三、对称评分框架（核心）
========================
记：S_LONG、S_SHORT ∈ [0,1]。两者对称构造，只改变符号/方向判断。最终“共振评分”为选择方向的分值。

权重建议（可调整）：
- 趋势框（Trend, 4h+1h）：0.30
- 动能框（Momentum, 30m+15m+3m）：0.20
- 位置框（Location, 价与EMA20/通道/斐波回撤区）：0.20
- 流动/密集（VPVR，POC/VA/接受）：0.10
- 形态/缺口（供需区 + FVG）：0.10
- 波动/可执行性（ATR比 & 资金费率/oi轻微偏置）：0.10

A) 趋势框（对称）
- LONG：4h MACD>0 +1格，1h MACD>0 +1格；价 ≥ 1h EMA20 +1/2格。至少满足两项才允许进入触发环节（也是 MUST-HAVE 之一）。
- SHORT：4h MACD<0 +1格，1h MACD<0 +1格；价 ≤ 1h EMA20 +1/2格。至少满足两项才允许进入触发环节。

B) 动能框（对称）
- LONG：30m MACD≥0、15m MACD≥0、3m MACD≥0 各加分；若其中有一层为负，则扣少量分，但允许“回抽后转正再触发”。
- SHORT：同理但取 MACD≤0 为加分。
- RSI7（15m）处于 55–75（多）或 45–25（空）视为“健康动能区”加分；
  - **超买/超卖守护**：
    - 多：若 15m RSI7>75，设置 guard_long="wait_pullback"（不否决，只延迟到回抽）。
    - 空：若 15m RSI7<25，设置 guard_short="wait_pullback"（不否决，只延迟到回抽）。

C) 位置框（对称）
- LONG：价接近 15m/30m EMA20 上方 & 通道“lower/middle”偏下部加分；若斐波回撤至 0.382–0.618 区并有看涨反应，加额外分。
- SHORT：价接近 15m/30m EMA20 下方 & 通道“upper/middle”偏上部加分；若斐波回撤至 0.382–0.618 区并有看跌反应，加额外分。

D) VPVR（对称）
- 在 1h/30m VA内为“接受区”，倾向顺势延续：
  - LONG：价位于 VA内且靠近 VAL→中位上行，加分；
  - SHORT：价位于 VA内且靠近 VAH→中位下行，加分；
- 接近/贴近POC通常先看“反应→延续/反转”的触发细则（见入场）；POC本身不直接给方向分，但可作为目标T1或触发位参照。

E) FVG + 供需区（对称）
- LONG：下方有“bullish FVG中位/需求区（强度≥60）”近支撑 → 加分；
- SHORT：上方有“bearish FVG中位/供应区（强度≥60）”近压制 → 加分；

F) 波动/可执行性（对称）
- 15m ATR / 1h ATR ≥ 0.35 视为短线波动充足，加分（<0.2 扣分）。
- 资金费率极端（|funding|>0.08%）且与方向同侧，略微扣分以防拥挤；OI 突增且价格下行（做空）/上行（做多）的一致性小幅加分（可选）。

========================
四、触发与闸门（MUST-HAVE + GUARDS）
========================
1) MUST-HAVE（先于触发）：
- LONG 至少满足以下三项中的两项：
  a) 4h MACD>0
  b) 1h MACD>0
  c) price ≥ 1h EMA20
- SHORT 至少满足以下三项中的两项：
  a) 4h MACD<0
  b) 1h MACD<0
  c) price ≤ 1h EMA20

2) 守护（不否决，只延迟到“回抽/再确认”）：
- guard_long="wait_pullback" 当 15m RSI7>75；
- guard_short="wait_pullback" 当 15m RSI7<25。

3) 最终触发门槛：
- 方向评分 ≥ 0.62 且 预计RR ≥ 1.6；
- 若守护触发，则需“回抽+反转”确认再下单（见入场细则）。
- 翻向保护：|S_LONG - S_SHORT| ≥ 0.12 才允许从上次方向翻向；若与上次相同方向，仅需 ≥0.06。

========================
五、入场/止损/止盈（对称执行细则）
========================
A) 做空（SHORT）
- 入场逻辑：
  - 优先“回抽做空”：等待价格回抽到 15m/30m EMA20 之间或最近 **bearish FVG 中位**/ 上方供应区边缘，出现看跌形态（上影/吞没/破低）后，使用**止损限价**：触发条件=“下破触发蜡烛低点 - 0.2*ATR(3m)”。
  - 如果30m MACD>0 与方向相反，可以保留评分，但**必须**出现上述回抽+反转后才允许入场。
- 初始止损（两者取更紧或更合逻辑）：
  - SL = 触发形态“最近摆动高点” + 0.7*ATR(3m)
  - 或 SL = 所在FVG上沿/供应区高位 + 0.5*ATR(3m)
- 止盈与RR：
  - T1 = VPVR中性位（POC或VA中位/对侧边），T2 = 最近**需求区**或斐波“1.000/1.272扩展位”；
  - 预计RR必须≥1.6；到达 +0.8R 后，将SL抬至BE（保本）；
  - 跟踪止损：
    - 方案一：Supertrend(3m) 跟踪；
    - 方案二：15m EMA20 + 0.5*ATR(15m) 动态跟踪。
- 取消条件：
  - 1h MACD翻正并持续≥N根（建议N=2-3）且价重回1h EMA20上方；
  - 守护“wait_pullback”超过M分钟未满足回抽（建议M=45-90）；
  - 结构被破坏：供应区被有效上破并放量、或bear FVG被完全填平并站稳。

B) 做多（LONG）（完全镜像，关键处号称“对称替换”）
- 入场逻辑：
  - 优先“回抽做多”：等待价格回抽到 15m/30m EMA20 之间或最近 **bullish FVG 中位**/ 下方需求区边缘，出现看涨形态（下影/吞没/破高）后**止损限价**：触发=“上破触发蜡烛高点 + 0.2*ATR(3m)”。
  - 若30m MACD<0 与方向相反，保留评分，但必须出现回抽+反转后入场。
- 初始止损：
  - SL = 最近摆动低点 - 0.7*ATR(3m)
  - 或 SL = FVG下沿/需求区低位 - 0.5*ATR(3m)
- 止盈与RR：
  - T1 = VPVR中性位（POC或VA中位/对侧边），T2 = 最近**供应区**或斐波“1.000/1.272扩展位”；
  - RR≥1.6；到 +0.8R 抬SL至BE；
  - 跟踪止损：Supertrend(3m) 或 15m EMA20 - 0.5*ATR(15m)。
- 取消条件：
  - 1h MACD转负并持续≥N根且价跌回1h EMA20下方；
  - 守护“wait_pullback”超时；
  - 需求区被有效跌破、bull FVG被灌穿且无法收回。

========================
六、RR估算与仓位计算（对称）
========================
- 估算RR：RR = |Entry - SL| : |TP(综合目标)|，若多目标则以T1的保守RR为下单门槛。
- 仓位 sizing（示例）：
  - 单笔风险 = 账户净值 * risk_pct（建议0.5% ~ 1.0%）；
  - 数量 = 单笔风险 / |Entry - SL|；若使用杠杆L，保证“占用保证金 ≤ 20%净值”且强平价远离关键区。

========================
七、冲突/自相矛盾的消解规则（必要时引用）
========================
- 优先级：4h趋势 > 1h趋势 > 30m动能 > 15m/3m触发；
- **允许“逆30m动能”的回抽入场**（明确规则已给出），但必须出现结构反转触发；
- 若两方向评分接近（|S_LONG - S_SHORT| < 0.06），择优“NONE”（观望）；
- 若上一轮建议是LONG（或SHORT），这轮欲翻向需满足：
  - |S_LONG - S_SHORT| ≥ 0.12 且 新方向满足MUST-HAVE；
  - 否则维持原方向或观望。

========================
八、诊断输出（可选但强烈推荐）
========================
---BEGIN DIAGNOSTICS---
S_LONG分解: Trend=?, Momentum=?, Location=?, VPVR=?, FVG/Zones=?, Volatility=? → 总分=?
S_SHORT分解: 同上 → 总分=?
守护: guard_long/guard_short = none | wait_pullback（触发因子：RSI7=...）
MUST-HAVE通过: LONG(?/3), SHORT(?/3)
RR估算: Entry=?, SL=?, T1=?, T2=?, 预计RR=?
关键参考价: 1hEMA20=?, 30mEMA20=?, 15mEMA20=?, 最近FVG中位(bear/bull)=?, VPVR(POC/VAH/VAL)=?
---END DIAGNOSTICS---

========================
九、执行话术（模板）
========================
当给出最终建议时，尽量简洁但要素齐全：
- “方向”只取 LONG/SHORT/NONE 之一；
- 要在“执行理由”里注明具体哪一层（4h/1h/30m/15m）提供了关键信号（MACD/EMA/RSI/通道/FVG/供需/VPVR），并列出具体价位；
- 明确“回抽”到哪里，“触发”是什么，“SL/TP”多少，“RR”多少；
- 明确“取消条件”。

========================
十、合规与风险提示
========================
- 本输出为教育与研究用途，非投资建议；
- 市场极端情形（剧烈插针/熔断）时，请使用“NONE或减仓/保本离场”逻辑优先级更高。
